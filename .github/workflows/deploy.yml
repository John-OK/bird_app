name: Deploy (manual)

on:
  workflow_dispatch:

jobs:
  deploy_production:
    if: github.ref == 'refs/heads/production'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS host key
        run: |
          PORT="${{ secrets.VPS_PORT }}"
          if [ -z "$PORT" ]; then PORT=22; fi
          mkdir -p ~/.ssh
          ssh-keyscan -p "$PORT" -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          set -euo pipefail
          PORT="$VPS_PORT"
          if [ -z "$PORT" ]; then PORT=22; fi

          ssh -p "$PORT" "$VPS_USER@$VPS_HOST" <<'EOF'
            set -euo pipefail

            REPO_DIR="/home/john/websites/bird_app"
            VENV_DIR="/home/john/websites/bird_app/.venv"

            cd "$REPO_DIR"
            git fetch origin production
            git switch production
            git reset --hard origin/production

            "$VENV_DIR/bin/pip" install -r requirements.txt
            "$VENV_DIR/bin/python" backend/manage.py migrate --noinput

            cd "$REPO_DIR/frontend"
            /usr/local/bin/npm ci
            /usr/local/bin/npm run build

            sudo systemctl restart hellobirdie.service
            systemctl is-active hellobirdie.service
          EOF
